# Copyright (C) 2022 - 2024 ANSYS, Inc. and/or its affiliates.
# SPDX-License-Identifier: MIT
#
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

name: >
  Documentation build action

description: >
  Build library documentation using `Sphinx
  <https://www.sphinx-doc.org/en/master/>`_. The action installs and uses
  `sphinx-build <https://www.sphinx-doc.org/en/master/man/sphinx-build.html>`_
  to generate documentation from the source. It requires that all the
  documentation is contained in the ``doc/`` directory of a project.
  Documentation dependencies need to be declared in a
  ``requirements/requirements_doc.txt`` file or in the ``[doc]`` section of the
  additional dependencies in the ``pyproject.toml`` file. Depending on the
  operating system, the action locates the ``doc/Makefile`` (resp. ``doc/make.bat``)
  file for Linux (resp. Windows) and runs the ``make html`` (resp. ``make.bat html``)
  and ``make pdf`` (resp. ``make.bat pdf``) commands. If desired, the ``make json``
  (resp. ``make.bat json``) command can also be executed to generate JSON documentation.

inputs:

  # Optional inputs

  python-version:
    description: >
        Python version used for installing and running ``Sphinx``.
    default: '3.10'
    required: false
    type: string

  use-python-cache:
    description: >
      Whether to use the Python cache for installing previously downloaded
      libraries. If ``true``, previously downloaded libraries are installed from the
      Python cache. If ``false``, libraries are downloaded from the PyPI index.
    required: false
    default: true
    type: boolean

  sphinxopts:
    description: >
      Set of options to pass to the ``Sphinx`` builder. Default options include
      using the maximum number of cores in the CPU of the machine and treating
      warnings as errors.

      .. note::

          This will override the ``SPHINXOPTS`` declared in your Makefile.

    default: '-j auto -W --keep-going'
    required: false
    type: string

  dependencies:
    description: >
      String of system dependencies to be installed before building the
      documentation of the project.
    default: ''
    required: false
    type: string

  skip-dependencies-cache:
    description: >
      Whether to ignore dependencies cache or not - for OS libraries.
    required: true
    default: false
    type: boolean

  requires-xvfb:
    description: >
      Whether to install `X Virtual Frame Buffer (XVFB)
      <https://www.x.org/releases/X11R7.6/doc/man/man1/Xvfb.1.xhtml>`_ and run
      the whole test session using XVFB. The default value is ``false``.

      If ``true``, installs `X Virtual Frame Buffer (XVFB)
      <https://www.x.org/releases/X11R7.6/doc/man/man1/Xvfb.1.xhtml>`_ and
      runs the whole test session using XVFB. Default value is ``false``.

      .. warning::

          This option is not taken into account when input ``os`` is set to ``'windows'``.
    default: false
    required: false
    type: boolean

  skip-install:
    description: >
      Whether to skip the installation of the project. The default is ``false``.
      Pure documentation projects require that this action be set to ``false``
      because there is no Python library associated with the project.
    default: false
    required: false
    type: boolean

  requirements-file:
    description: >
      Path to the requirements file in case it needs to be in a specific location.
      This is useful for non python projects, where you don't necessarily have a requirements
      file in the root of the project.
    default: 'requirements/requirements_doc.txt'
    required: false
    type: string

  checkout:
    description: >
      Whether to clone the repository in the CI/CD machine. Default value is
      ``true``.
    default: true
    required: false
    type: boolean

  skip-json-build:
    description: >
      Whether to skip the generation of JSON documentation. Default value is
      ``true``.
    default: true
    required: false
    type: boolean

  check-links:
    description: >
      Whether to perform external link checks during the generation of
      documentation. Default value is ``true``.
    default: true
    required: false
    type: boolean

  os:
    description: >
      Operating system expected to build the documentation. Default value is `linux`.
    default: 'linux'
    required: false
    type: string

runs:
  using: "composite"
  steps:

    # --------------- Common to linux and windows doc-build ----------------

    - name: "Set up Python"
      uses: ansys/actions/_setup-python@main
      with:
        python-version: ${{ inputs.python-version }}
        use-cache: ${{ inputs.use-python-cache }}

    - name: "Update pip"
      shell: bash
      run: python -m pip install -U pip

    - name: "Install Git and clone project"
      uses: actions/checkout@v4
      if: ${{ inputs.checkout == 'true' }}

    # ------------------------------------------------------------------------

    - name: Documentation build (Linux)
      if: ${{ inputs.os == 'linux' }}
      uses: SMoraisAnsys/actions/_doc-build-linux@feat/doc-build-os-compatible
      with:
        python-version: ${{ inputs.python-version }}
        use-python-cache: ${{ inputs.use-python-cache }}
        sphinxopts: ${{ inputs.sphinxopts }}
        dependencies: ${{ inputs.dependencies }}
        skip-dependencies-cache: ${{ inputs.skip-dependencies-cache }}
        requires-xvfb: ${{ inputs.requires-xvfb }}
        skip-install: ${{ inputs.skip-install }}
        requirements-file: ${{ inputs.requirements-file }}
        checkout: ${{ inputs.checkout }}
        skip-json-build: ${{ inputs.skip-json-build }}
        check-links: ${{ inputs.check-links }}

    # ------------------------------------------------------------------------

    - name: Check input (Windows)
      if: ${{ (inputs.os == 'windows') && (inputs.requires-xvfb == 'true') }}
      shell: powershell
      run: |
        Write-Host "$([char]27)[33mX virtual framebuffer is not used when building with Windows.$([char]27)[0m"

    - name: Documentation build (Windows)
      if: ${{ inputs.os == 'windows' }}
      uses: SMoraisAnsys/actions/_doc-build-windows@feat/doc-build-os-compatible
      with:
        python-version: ${{ inputs.python-version }}
        use-python-cache: ${{ inputs.use-python-cache }}
        sphinxopts: ${{ inputs.sphinxopts }}
        dependencies: ${{ inputs.dependencies }}
        skip-dependencies-cache: ${{ inputs.skip-dependencies-cache }}
        skip-install: ${{ inputs.skip-install }}
        requirements-file: ${{ inputs.requirements-file }}
        checkout: ${{ inputs.checkout }}
        skip-json-build: ${{ inputs.skip-json-build }}
        check-links: ${{ inputs.check-links }}
