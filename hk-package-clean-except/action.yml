# Copyright (C) 2022 - 2026 ANSYS, Inc. and/or its affiliates.
# SPDX-License-Identifier: MIT
#
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

name: "Clean all package versions except certain tags."
description: |
  "Action cleaning up all package versions published at ghcr.io except for certain tags."

  .. note::

    If an image matched by ``tags-kept`` has multiple tags (which are potentially not in the ``tags-kept`` list),
    then the entire image (with all its tags) will be kept.

inputs:
  package-name:
    description: "Package name."
    required: true
    type: string
  token:
    description: "Token with package deletion permissions."
    required: true
    type: string
  tags-kept:
    description: "Tags to be kept. Pass them as a list: e.g. 'latest, latest-unstable'."
    required: true
    type: string
  package-org:
    description: "Organization at which packages are published."
    required: false
    default: 'ansys'
    type: string
  allow-last-days:
    description: "Avoid removing the last N days images: e.g. '2'."
    required: false
    default: ''
    type: string
  python-version:  # TODO: Remove deprecated input in v11
    description: 'DEPRECATED ARGUMENT. Desired Python version.'
    default: ''
    required: false
    type: string
  use-uv:  # TODO: Remove deprecated input in v11
    description: |
      DEPRECATED ARGUMENT. Whether to use uv as the default package manager instead of pip. Default value is ``''``.
    default: ''
    required: false
    type: string

runs:
  using: "composite"
  steps:

    - uses: ansys/actions/_logging@main
      if: inputs.python-version != '' || inputs.use-uv != ''
      with:
        level: "WARNING"
        message: >
          'The "python-version" and "use-uv" inputs are deprecated and will be
          removed in future releases. This action uses a specific Python version set
          up in a separate step.'

    - name: "Set up Python 3.13"
      uses: ansys/actions/_setup-python@main
      with:
        python-version: '3.13'
        use-cache: false
        provision-uv: true
        prune-uv-cache: true

    - name: "Install required packages"
      shell: bash
      env:
        ACTION_PATH: ${{ github.action_path }}
      run: |
        uv pip install --no-managed-python --system --upgrade pip
        uv pip install --no-managed-python --system --no-deps -r ${ACTION_PATH}/requirements.txt

    - name: "Run package cleanup"
      shell: bash
      env:
        ALLOW_LAST_DAYS: ${{ inputs.allow-last-days }}
        PACKAGE_ORG: ${{ inputs.package-org }}
        PACKAGE_NAME: ${{ inputs.package-name }}
        PACKAGE_DELETION_TOKEN: ${{ inputs.token }}
        VALID_TAGS_STR: ${{ inputs.tags-kept }}
      run: |
        python ${{ github.action_path }}/../python-utils/hk_package_clean_except.py
